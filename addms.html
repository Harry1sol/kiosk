<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreshMart - Admin</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary: #2e7d32; --white: #ffffff; --bg-light: #f4f6f8; --text-dark: #333; --border-radius: 8px; --shadow: 0 2px 8px rgba(0,0,0,0.05); }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-light); color: var(--text-dark); height: 100vh; display: flex; flex-direction: column; }
        
        header { background: var(--white); padding: 15px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; }
        h1 { color: var(--primary); }
        
        main { flex: 1; overflow-y: auto; padding: 20px; }
        
        .tabs { display: flex; margin-bottom: 20px; gap: 10px; }
        .tab-btn { padding: 10px 20px; background: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; color: #777; }
        .tab-btn.active { background: var(--primary); color: white; }
        
        .panel { background: var(--white); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 20px; display: none; }
        .panel.active { display: block; }

        /* Form */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 0.85rem; color: #666; font-weight: 600; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: #d32f2f; color: white; padding: 5px 10px; font-size: 0.85rem; }
        .btn-edit { background: #e3f2fd; color: #1976d2; padding: 5px 10px; font-size: 0.85rem; margin-right: 5px; cursor: pointer; border: none; border-radius: 4px; }

        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { font-weight: 600; color: #555; font-size: 0.9rem; }
        .img-preview { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; background: #eee; }
        
        /* Switch */
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(14px); }

        /* Order Cards in Admin */
        .orders-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .order-card { background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 15px; }
        .order-card.status-Received { border-left: 4px solid #f57c00; }
        .order-card.status-Picking { border-left: 4px solid #1976d2; }
        .order-card.status-Ready { border-left: 4px solid #388e3c; }
        .order-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>
    <header>
        <h1>Store Admin</h1>
    </header>
    
    <main>
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('inventory')">Inventory</button>
            <button class="tab-btn" onclick="showTab('orders')">Order History</button>
        </div>

        <!-- Inventory Panel -->
        <div id="inventory-panel" class="panel active">
            <form id="inv-form" onsubmit="handleSub(event)">
                <input type="hidden" id="edit-id">
                <div class="form-grid">
                    <div class="input-group"><label>Item Name</label><input type="text" id="inp-name" placeholder="e.g. Orange Juice" required></div>
                    <div class="input-group"><label>Category</label><select id="inp-cat"><option value="Fruits">Fruits</option><option value="Vegetables">Vegetables</option><option value="Dairy">Dairy</option><option value="Bakery">Bakery</option></select></div>
                    <div class="input-group"><label>Price (₹)</label><input type="number" id="inp-price" step="0.01" placeholder="0.00" required></div>
                    <div class="input-group" style="grid-column: span 2;"><label>Image Link (Paste URL)</label><input type="text" id="inp-img" placeholder="https://example.com/image.jpg"></div>
                    <button type="submit" class="btn btn-primary">Save Item</button>
                    <button type="button" class="btn" style="background:#eee; color:#333;" onclick="resetForm()">Clear</button>
                </div>
            </form>
            <table><thead><tr><th>Img</th><th>Name</th><th>Category</th><th>Price</th><th>Avail</th><th>Action</th></tr></thead><tbody id="inv-body"></tbody></table>
        </div>

        <!-- Orders Panel -->
        <div id="orders-panel" class="panel">
            <h3>All Orders</h3>
            <div class="orders-container" id="admin-orders-list">Loading orders...</div>
        </div>
    </main>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyDrbVUUk2hH2_2LaWvaRSQIGqSbQnsC5pQ", authDomain: "kiosk-4d556.firebaseapp.com", projectId: "kiosk-4d556", storageBucket: "kiosk-4d556.firebasestorage.app", messagingSenderId: "15848211380", appId: "1:15848211380:web:0afd9de1f69ea490aba8e1", measurementId: "G-CBRRT8JFQV" };
        firebase.initializeApp(firebaseConfig); const db = firebase.firestore();
        
        // Tab Switching
        function showTab(id) {
            document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById(id+'-panel').classList.add('active');
            // Highlight clicked button logic
            const btns = document.querySelectorAll('.tab-btn');
            if(id === 'inventory') btns[0].classList.add('active');
            else btns[1].classList.add('active');
        }

        const DB = {
            getItems: async ()=>(await db.collection('items').get()).docs.map(d=>d.data()),
            saveItems: async (its)=>{ const b=db.batch(); its.forEach(i=>b.set(db.collection('items').doc(String(i.id)),i)); await b.commit(); },
            listenOrders: (cb)=>db.collection('orders').orderBy('timestamp','desc').onSnapshot(s=>cb(s.docs.map(d=>({id:d.id,...d.data()}))))
        };

        // --- RENDER INVENTORY ---
        async function renderInv(){ 
            const its = await DB.getItems(); 
            const tb = document.getElementById('inv-body'); 
            tb.innerHTML=''; 
            its.forEach(i=>{ 
                const imgSrc = i.image || `https://picsum.photos/seed/${i.name.replace(/\s/g,'')}/50/50`; 
                tb.innerHTML+=`<tr>
                    <td><img src="${imgSrc}" class="img-preview"></td>
                    <td>${i.name}</td>
                    <td>${i.category}</td>
                    <td>₹${parseFloat(i.price).toFixed(2)}</td>
                    <td><label class="switch"><input type="checkbox" ${i.available?'checked':''} onchange="toggle('${i.id}')"><span class="slider"></span></label></td>
                    <td>
                        <button class="btn-edit" onclick="editItem('${i.id}')">Edit</button>
                        <button class="btn-danger" onclick="delItem('${i.id}')">Del</button>
                    </td>
                </tr>`; 
            }); 
        }

        // --- HANDLE SAVE (ADD/EDIT) ---
        async function handleSub(e){ 
            e.preventDefault(); 
            
            // Read values
            const id = document.getElementById('edit-id').value; 
            const n = document.getElementById('inp-name').value; 
            const c = document.getElementById('inp-cat').value; 
            const p = parseFloat(document.getElementById('inp-price').value); // Ensure number
            const img = document.getElementById('inp-img').value;

            let its = await DB.getItems(); 
            
            if(id){ 
                // Update Existing
                const idx=its.findIndex(i=>String(i.id) === String(id)); // Strict string comparison
                if(idx!==-1){ 
                    its[idx]={...its[idx], name:n, category:c, price:p, image: img}; 
                    alert('Item Updated Successfully');
                } 
            } else { 
                // Create New
                its.push({id:Date.now(), name:n, category:c, price:p, available:true, image: img}); 
                alert('Item Added Successfully');
            } 
            await DB.saveItems(its); 
            resetForm();
            renderInv(); 
        }

        // --- EDIT ITEM ---
        async function editItem(id){ 
            const its = await DB.getItems(); 
            const i=its.find(x=>String(x.id) === String(id)); // Safe comparison
            if(i){ 
                // Populate form
                document.getElementById('edit-id').value=i.id; 
                document.getElementById('inp-name').value=i.name; 
                document.getElementById('inp-cat').value=i.category; 
                document.getElementById('inp-price').value=i.price;
                document.getElementById('inp-img').value = i.image || '';
                // Scroll to top
                document.querySelector('.panel').scrollIntoView({behavior:'smooth'});
            } else {
                alert("Error: Could not find item.");
            }
        } 

        // --- DELETE ITEM ---
        async function delItem(id){ 
            if(confirm('Delete this item permanently?')){ 
                const its = await DB.getItems(); 
                const newIts = its.filter(x=>String(x.id) !== String(id)); 
                await DB.saveItems(newIts); 
                renderInv(); 
            } 
        }

        function resetForm() {
            document.getElementById('inv-form').reset();
            document.getElementById('edit-id').value = '';
        }

        // --- TOGGLE AVAILABILITY ---
        async function toggle(id){ 
            const its = await DB.getItems(); 
            const i=its.find(x=>String(x.id) === String(id)); 
            if(i){ 
                i.available=!i.available; 
                await DB.saveItems(its); 
            } 
        }

        // --- ADMIN ORDERS HISTORY ---
        DB.listenOrders(orders => {
            const c = document.getElementById('admin-orders-list');
            c.innerHTML = '';
            if(orders.length === 0) c.innerHTML = "No orders yet.";
            orders.forEach(o => {
                const t = o.timestamp ? new Date(o.timestamp.seconds * 1000).toLocaleString() : 'Just now';
                const itemsHtml = o.items.map(i => `<div style="font-size:0.85rem; display:flex; justify-content:space-between;"><span>${i.qty}x ${i.name}</span><span>₹${(i.price*i.qty).toFixed(2)}</span></div>`).join('');
                c.innerHTML += `<div class="order-card status-${o.status}"><div class="order-header"><span>#${o.id}</span><span>${o.status}</span></div><div style="font-size:0.8rem; color:#666; margin-bottom:5px;">${t}</div>${itemsHtml}<div style="text-align:right; font-weight:bold; margin-top:10px;">₹${o.total.toFixed(2)}</div></div>`;
            });
        });

        // Initial Load
        renderInv();
    </script>
</body>
</html>