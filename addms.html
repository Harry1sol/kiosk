<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MittalMart - HQ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary: #2e7d32; --bg: #f3f4f6; --white: #ffffff; --text: #1f2937; --border: #e5e7eb; --radius: 8px; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background-color: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        aside { width: 250px; background: var(--white); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--primary); margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .nav-item { padding: 12px 15px; border-radius: var(--radius); cursor: pointer; color: #6b7280; font-weight: 600; margin-bottom: 5px; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover { background: #f9fafb; color: var(--primary); }
        .nav-item.active { background: #f0fdf4; color: var(--primary); }

        main { flex: 1; padding: 30px; overflow-y: auto; }
        .view-section { display: none; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h2 { font-size: 1.8rem; }
        
        .btn { padding: 10px 20px; border-radius: var(--radius); border: none; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(46, 125, 50, 0.2); }
        .btn-danger { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); }
        .stat-val { font-size: 2rem; font-weight: 800; color: var(--primary); }
        .stat-label { color: #6b7280; font-size: 0.9rem; }

        .table-container { background: white; border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f9fafb; text-align: left; padding: 15px; font-size: 0.85rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 0.95rem; vertical-align: middle; }
        .item-row:hover { background: #f9fafb; }
        .product-thumb { width: 40px; height: 40px; border-radius: 6px; object-fit: cover; background: #eee; }
        
        .action-btn { background: none; border: none; cursor: pointer; padding: 5px; color: #6b7280; }
        .action-btn:hover { color: var(--primary); }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; }
        .badge-stock { background: #dcfce7; color: #166534; }
        .badge-out { background: #fee2e2; color: #991b1b; }

        /* CATEGORY EDIT CARDS */
        .cat-edit-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .cat-edit-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid #eee; display: flex; gap: 15px; align-items: center; position: relative; }
        .cat-edit-img { width: 60px; height: 60px; border-radius: 8px; object-fit: contain; background: #f8fafc; border: 1px solid #eee; }
        .cat-edit-info { flex: 1; }
        .cat-edit-info h4 { margin-bottom: 5px; font-size: 1rem; }
        .cat-edit-info p { font-size: 0.8rem; color: #666; word-break: break-all; }
        .btn-cat-del { position: absolute; top: 10px; right: 10px; color: #ef4444; border: none; background: #fef2f2; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* MODAL */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 100; opacity: 0; pointer-events: none; transition: 0.2s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal { background: white; width: 400px; padding: 25px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); transform: translateY(20px); transition: 0.3s; }
        .modal-overlay.open .modal { transform: translateY(0); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; font-weight: 600; color: #374151; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; outline: none; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    </style>
</head>
<body>
    <aside>
        <div class="logo">üõí MittalHQ</div>
        <div class="nav-item active" onclick="switchView('inventory')">üì¶ Inventory</div>
        <div class="nav-item" onclick="switchView('categories')">üñº Categories</div>
        <div class="nav-item" onclick="switchView('analytics')">üìä Analytics</div>
        <div class="nav-item" onclick="switchView('settings')">‚öôÔ∏è Settings</div>
    </aside>

    <main>
        <!-- VIEW 1: INVENTORY -->
        <div id="view-inventory" class="view-section active">
            <div class="header"><h2>Inventory Management</h2><button class="btn btn-primary" onclick="openModal()">+ Add New Item</button></div>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-val" id="total-items">0</div><div class="stat-label">Total Products</div></div>
                <div class="stat-card"><div class="stat-val" id="out-of-stock">0</div><div class="stat-label">Out of Stock</div></div>
                <div class="stat-card"><div class="stat-val" id="today-revenue">‚Çπ0.00</div><div class="stat-label">Today's Revenue</div></div>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th width="60">Img</th><th>Product Name</th><th>Category</th><th>Price</th><th>Status</th><th style="text-align:right">Actions</th></tr></thead>
                    <tbody id="inv-body"></tbody>
                </table>
            </div>
        </div>

        <!-- VIEW 2: CATEGORIES -->
        <div id="view-categories" class="view-section">
            <div class="header"><h2>Manage Categories</h2><button class="btn btn-primary" onclick="openCatModal()">+ Add Category</button></div>
            <div class="cat-edit-grid" id="cat-grid">
                <!-- Injected by JS -->
            </div>
        </div>

        <!-- VIEW 3: ANALYTICS -->
        <div id="view-analytics" class="view-section">
            <div class="header"><h2>Analytics</h2><button class="btn btn-primary" onclick="loadHistory()">üîÑ Refresh</button></div>
            <div class="stats-grid">
                <div class="stat-card" style="border-left: 5px solid #3b82f6;"><div class="stat-val" id="yesterday-revenue">‚Çπ0.00</div><div class="stat-label">Yesterday's Revenue</div></div>
                 <div class="stat-card" style="border-left: 5px solid #2e7d32;"><div class="stat-val" id="today-revenue-ana">‚Çπ0.00</div><div class="stat-label">Today's Revenue</div></div>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Order ID</th><th>Date/Time</th><th>Items</th><th>Total</th><th>Status</th></tr></thead>
                    <tbody id="history-body"></tbody>
                </table>
            </div>
        </div>

        <!-- VIEW 4: SETTINGS -->
        <div id="view-settings" class="view-section">
            <div class="header"><h2>Settings</h2></div>
            <div class="stat-card" style="max-width: 500px;">
                <h3 style="margin-bottom:15px;">Danger Zone</h3>
                <button class="btn btn-danger" onclick="resetData()">‚ö† Reset All Data</button>
            </div>
        </div>
    </main>

    <!-- ADD/EDIT ITEM MODAL -->
    <div class="modal-overlay" id="item-modal">
        <div class="modal">
            <h3 style="margin-bottom:15px;">Product Details</h3>
            <form id="item-form" onsubmit="handleSave(event)">
                <input type="hidden" id="inp-id">
                <div class="form-group"><label>Name</label><input type="text" id="inp-name" required placeholder="e.g. Amul Butter"></div>
                <!-- Dynamic Category Dropdown -->
                <div class="form-group"><label>Category</label><select id="inp-cat" required><option>Loading...</option></select></div>
                <div class="form-group"><label>Price (‚Çπ)</label><input type="number" id="inp-price" step="0.01" required></div>
                <div class="form-group"><label>Image URL</label><input type="text" id="inp-img" placeholder="https://..."></div>
                <div class="modal-actions"><button type="button" class="btn" onclick="closeModal('item-modal')" style="background:#f3f4f6">Cancel</button><button type="submit" class="btn btn-primary">Save Item</button></div>
            </form>
        </div>
    </div>

    <!-- ADD CATEGORY MODAL -->
    <div class="modal-overlay" id="cat-modal">
        <div class="modal">
            <h3 style="margin-bottom:15px;">New Category</h3>
            <form onsubmit="handleCatSave(event)">
                <div class="form-group"><label>Category Name</label><input type="text" id="new-cat-name" required placeholder="e.g. Pet Care"></div>
                <div class="form-group"><label>Image URL</label><input type="text" id="new-cat-img" required placeholder="https://..."></div>
                <div class="form-group"><label>Background Color</label><select id="new-cat-color"><option value="cat-bg-1">Blueish</option><option value="cat-bg-2">Greenish</option><option value="cat-bg-3">Yellowish</option><option value="cat-bg-4">Reddish</option></select></div>
                <div class="modal-actions"><button type="button" class="btn" onclick="closeModal('cat-modal')" style="background:#f3f4f6">Cancel</button><button type="submit" class="btn btn-primary">Create</button></div>
            </form>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDrbVUUk2hH2_2LaWvaRSQIGqSbQnsC5pQ", authDomain: "kiosk-4d556.firebaseapp.com", projectId: "kiosk-4d556", storageBucket: "kiosk-4d556.firebasestorage.app", messagingSenderId: "15848211380", appId: "1:15848211380:web:0afd9de1f69ea490aba8e1", measurementId: "G-CBRRT8JFQV" };
        firebase.initializeApp(firebaseConfig); const db = firebase.firestore();

        let ITEMS = [];
        let CATEGORIES = [];

        async function init() {
            // Check if categories exist, if not seed defaults
            const snap = await db.collection('categories').get();
            if(snap.empty) {
                const defaults = [
                    { id: 'Fruits', name: 'Fruits & Veggies', img: 'https://cdn-icons-png.flaticon.com/512/3063/3063823.png', color: 'cat-bg-2' },
                    { id: 'Dairy', name: 'Dairy, Bread & Eggs', img: 'https://cdn-icons-png.flaticon.com/512/3050/3050158.png', color: 'cat-bg-1' },
                    { id: 'Snacks', name: 'Chips & Munchies', img: 'https://cdn-icons-png.flaticon.com/512/2553/2553691.png', color: 'cat-bg-3' },
                    { id: 'Beverages', name: 'Cold Drinks & Juices', img: 'https://cdn-icons-png.flaticon.com/512/2405/2405597.png', color: 'cat-bg-4' },
                    { id: 'Essentials', name: 'Home Essentials', img: 'https://cdn-icons-png.flaticon.com/512/2554/2554039.png', color: 'cat-bg-1' },
                    { id: 'Bakery', name: 'Biscuits & Bakery', img: 'https://cdn-icons-png.flaticon.com/512/992/992747.png', color: 'cat-bg-3' }
                ];
                const b = db.batch();
                defaults.forEach(d => b.set(db.collection('categories').doc(d.id), d));
                await b.commit();
            }
            await loadCats();
            await loadInv();
        }

        async function loadCats() {
            const s = await db.collection('categories').get();
            CATEGORIES = s.docs.map(d => ({id: d.id, ...d.data()}));
            
            // Populate Dropdown for Item Adding
            const dropdown = document.getElementById('inp-cat');
            dropdown.innerHTML = CATEGORIES.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        function switchView(viewId) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            if(viewId === 'analytics') loadHistory();
            if(viewId === 'categories') renderCatGrid();
        }

        async function loadInv(){
            const s = await db.collection('items').get();
            ITEMS = s.docs.map(d=>d.data());
            renderInventoryTable();
            calculateRevenue();
        }

        // --- CATEGORY MANAGEMENT ---
        function renderCatGrid() {
            const grid = document.getElementById('cat-grid');
            grid.innerHTML = '';
            CATEGORIES.forEach(c => {
                grid.innerHTML += `
                    <div class="cat-edit-card">
                        <img src="${c.img}" class="cat-edit-img">
                        <div class="cat-edit-info">
                            <h4>${c.name}</h4>
                            <p>${c.id}</p>
                        </div>
                        <button class="btn-cat-del" onclick="deleteCategory('${c.id}')" title="Delete Category">√ó</button>
                    </div>
                `;
            });
        }

        function openCatModal() { 
            document.getElementById('new-cat-name').value = ''; 
            document.getElementById('new-cat-img').value = ''; 
            document.getElementById('cat-modal').classList.add('open'); 
        }

        async function handleCatSave(e) {
            e.preventDefault();
            const name = document.getElementById('new-cat-name').value;
            const img = document.getElementById('new-cat-img').value;
            const color = document.getElementById('new-cat-color').value;
            
            // Simple ID generation (remove spaces)
            const id = name.replace(/[^a-zA-Z0-9]/g, '');
            
            await db.collection('categories').doc(id).set({
                id: id, name: name, img: img, color: color
            });
            
            await loadCats();
            renderCatGrid();
            closeModal('cat-modal');
        }

        async function deleteCategory(id) {
            if(confirm(`Delete category '${id}'? This won't delete items inside it, but they won't show up in the customer app.`)) {
                await db.collection('categories').doc(id).delete();
                await loadCats();
                renderCatGrid();
            }
        }

        // --- INVENTORY RENDER ---
        function renderInventoryTable(){
            const tb = document.getElementById('inv-body'); tb.innerHTML = '';
            let outCount = 0;
            ITEMS.forEach(i => {
                if(!i.available) outCount++;
                const img = i.image || `https://ui-avatars.com/api/?name=${i.name}&background=random`;
                // Find pretty category name
                const catObj = CATEGORIES.find(c => c.id === i.category);
                const catName = catObj ? catObj.name : i.category;

                tb.innerHTML += `<tr class="item-row"><td><img src="${img}" class="product-thumb"></td><td style="font-weight:600">${i.name}</td><td><span style="background:#eee; padding:2px 8px; border-radius:4px; font-size:0.8rem">${catName}</span></td><td>‚Çπ${i.price}</td><td><span class="badge ${i.available ? 'badge-stock' : 'badge-out'}">${i.available ? 'In Stock' : 'Unavailable'}</span></td><td style="text-align:right"><button class="action-btn" onclick="toggleStock('${i.id}')" title="Toggle Stock">üîÑ</button><button class="action-btn" onclick="editItem('${i.id}')" title="Edit">‚úèÔ∏è</button><button class="action-btn" onclick="delItem('${i.id}')" title="Delete" style="color:#ef4444">üóëÔ∏è</button></td></tr>`;
            });
            document.getElementById('total-items').innerText = ITEMS.length;
            document.getElementById('out-of-stock').innerText = outCount;
        }

        async function calculateRevenue() {
            const today = new Date(); today.setHours(0,0,0,0);
            const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);
            const yesterday = new Date(today); yesterday.setDate(today.getDate() - 1);
            let todayTotal = 0, yesterTotal = 0;
            try {
                const snapToday = await db.collection('orders').where('timestamp', '>=', today).where('timestamp', '<', tomorrow).get();
                snapToday.forEach(d => { if(d.data().total) todayTotal += d.data().total; });
                const snapYester = await db.collection('orders').where('timestamp', '>=', yesterday).where('timestamp', '<', today).get();
                snapYester.forEach(d => { if(d.data().total) yesterTotal += d.data().total; });
            } catch(e) { console.log(e); }
            document.getElementById('today-revenue').innerText = `‚Çπ${todayTotal.toFixed(2)}`;
            const trA = document.getElementById('today-revenue-ana'); if(trA) trA.innerText = `‚Çπ${todayTotal.toFixed(2)}`;
            const yr = document.getElementById('yesterday-revenue'); if(yr) yr.innerText = `‚Çπ${yesterTotal.toFixed(2)}`;
        }

        async function loadHistory() {
            calculateRevenue();
            const tbody = document.getElementById('history-body');
            tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';
            try {
                const snap = await db.collection('orders').orderBy('timestamp', 'desc').limit(30).get();
                tbody.innerHTML = '';
                if(snap.empty) { tbody.innerHTML = '<tr><td colspan="5">No orders found.</td></tr>'; return; }
                snap.forEach(doc => {
                    const o = doc.data();
                    const date = o.timestamp ? new Date(o.timestamp.seconds*1000).toLocaleString() : 'N/A';
                    const itemsSummary = o.items.map(i => `${i.qty}x ${i.name}`).join(', ');
                    tbody.innerHTML += `<tr><td style="font-family:monospace; font-weight:bold;">${o.id}</td><td>${date}</td><td style="max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${itemsSummary}">${itemsSummary}</td><td style="font-weight:bold;">‚Çπ${o.total.toFixed(2)}</td><td><span class="badge" style="background:${o.status==='Completed'?'#dcfce7':(o.status==='Ready'?'#dcfce7':'#e0f2fe')}; color:#333">${o.status}</span></td></tr>`;
                });
            } catch(e) { console.error(e); }
        }

        function openModal() { document.getElementById('item-form').reset(); document.getElementById('inp-id').value = ''; document.getElementById('item-modal').classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        
        async function handleSave(e) {
            e.preventDefault();
            const id = document.getElementById('inp-id').value;
            const data = { name: document.getElementById('inp-name').value, category: document.getElementById('inp-cat').value, price: parseFloat(document.getElementById('inp-price').value), image: document.getElementById('inp-img').value, available: true, id: id ? Number(id) : Date.now() };
            const batch = db.batch();
            batch.set(db.collection('items').doc(String(data.id)), data, {merge:true});
            await batch.commit();
            closeModal('item-modal'); loadInv();
        }
        
        async function editItem(id) { const item = ITEMS.find(i => String(i.id) === String(id)); if(item) { document.getElementById('inp-id').value = item.id; document.getElementById('inp-name').value = item.name; document.getElementById('inp-cat').value = item.category; document.getElementById('inp-price').value = item.price; document.getElementById('inp-img').value = item.image || ''; document.getElementById('item-modal').classList.add('open'); } }
        async function toggleStock(id) { const item = ITEMS.find(i => String(i.id) === String(id)); if(item) { await db.collection('items').doc(String(id)).update({ available: !item.available }); loadInv(); } }
        async function delItem(id) { if(confirm('Delete this item?')) { await db.collection('items').doc(String(id)).delete(); loadInv(); } }
        
        async function resetData() {
            if(confirm("‚ö† WARNING: This wipes ALL Items, Categories, and Orders. Are you sure?")) {
                // Not implementing actual wipe loop for safety, but in production you'd loop deletes.
                alert("Reset simulated. In production this would iterate and delete collections.");
            }
        }
        
        init();
    </script>
</body>
</html>
